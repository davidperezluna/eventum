<div class="reportes-page">
  <header class="page-header">
    <div>
      <h1>
        <span class="material-icons">assessment</span>
        Reportes
      </h1>
      <p>Genera reportes y estadísticas del sistema</p>
    </div>
  </header>

  <!-- Filtros -->
  <div class="filters-card">
    <div class="form-row">
      <div class="form-group" *ngIf="esAdministrador">
        <label>Organizador (Opcional)</label>
        <select [(ngModel)]="organizadorFiltro" (change)="onOrganizadorChange()" [disabled]="loadingOrganizadores">
          <option [ngValue]="null">Todos los organizadores</option>
          <option *ngFor="let org of organizadores" [ngValue]="org.id">
            {{ org.nombre }} {{ org.apellido }}
          </option>
        </select>
        <div *ngIf="loadingOrganizadores" class="loader-inline">
          <span class="material-icons spin">hourglass_empty</span>
          Cargando organizadores...
        </div>
      </div>
      <div class="form-group">
        <label>Evento (Opcional)</label>
        <select [(ngModel)]="eventoSeleccionado" (change)="onEventoChange()" [disabled]="loadingEventos || (!organizadorFiltro && esAdministrador)">
          <option [ngValue]="null">Todos los eventos</option>
          <option *ngFor="let evento of eventos" [ngValue]="evento.id">
            {{ evento.titulo }} 
            <span *ngIf="evento.estado === 'finalizado'">(Finalizado)</span>
            <span *ngIf="evento.estado === 'cancelado'">(Cancelado)</span>
          </option>
        </select>
        <div *ngIf="loadingEventos" class="loader-inline">
          <span class="material-icons spin">hourglass_empty</span>
          Cargando eventos...
        </div>
        <div *ngIf="!loadingEventos && esAdministrador && !organizadorFiltro && eventos.length === 0" class="helper-text">
          Selecciona un organizador para ver sus eventos
        </div>
      </div>
      <div class="form-group">
        <button class="btn-primary" (click)="generarReporte()" [disabled]="loading || loadingEventos || (esAdministrador && !organizadorFiltro)">
          <span class="material-icons">{{ loading ? 'hourglass_empty' : 'refresh' }}</span>
          {{ loading ? 'Generando...' : 'Generar Reporte' }}
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading-state">Generando reportes...</div>

  <div *ngIf="!loading && !reporteVentas && !reporteEventos" class="content-card">
    <p>No se encontraron datos con los filtros seleccionados.</p>
  </div>

  <!-- Reporte de Ventas -->
  <div *ngIf="!loading && reporteVentas" class="content-card">
    <h2>
      <span class="material-icons">attach_money</span>
      Reporte de Ventas
    </h2>
    
    <div class="stats-grid">
      <div class="stat-card">
        <span class="material-icons stat-icon">shopping_cart</span>
        <div class="stat-content">
          <h3>Total Compras</h3>
          <p class="stat-value">{{ reporteVentas.totalCompras }}</p>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-icons stat-icon">check_circle</span>
        <div class="stat-content">
          <h3>Completadas</h3>
          <p class="stat-value">{{ reporteVentas.comprasCompletadas }}</p>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-icons stat-icon">payments</span>
        <div class="stat-content">
          <h3>Subtotal</h3>
          <p class="stat-value">${{ reporteVentas.totalSubtotal | number:'1.0-0' }}</p>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-icons stat-icon">loyalty</span>
        <div class="stat-content">
          <h3>Total Descuentos</h3>
          <p class="stat-value" style="color: var(--color-danger, #f44336)">${{ reporteVentas.totalDescuentos | number:'1.0-0' }}</p>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-icons stat-icon">attach_money</span>
        <div class="stat-content">
          <h3>Total Ingresos (Neto)</h3>
          <p class="stat-value">${{ reporteVentas.totalIngresos | number:'1.0-0' }}</p>
        </div>
      </div>
    </div>

    <div class="report-section">
      <h3>Compras por Estado de Pago</h3>
      <div class="chart-data">
        <div *ngFor="let item of reporteVentas.comprasPorEstado | keyvalue" class="chart-item">
          <span class="chart-label">{{ item.key }}</span>
          <span class="chart-value">{{ item.value }}</span>
        </div>
      </div>
    </div>

    <div class="report-section">
      <h3>Compras por Método de Pago</h3>
      <div class="chart-data">
        <div *ngFor="let item of reporteVentas.comprasPorMetodo | keyvalue" class="chart-item">
          <span class="chart-label">{{ item.key }}</span>
          <span class="chart-value">{{ item.value }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Reporte de Comisiones y Neto -->
  <div *ngIf="!loading && reporteComisiones" class="content-card">
    <h2>
      <span class="material-icons">calculate</span>
      Comisiones y Neto (Wompi 2.65% + $700 + IVA)
    </h2>

    <div class="stats-grid">
      <div class="stat-card">
        <span class="material-icons stat-icon">payments</span>
        <div class="stat-content">
          <h3>Total Bruto</h3>
          <p class="stat-value">${{ reporteComisiones.totalBruto | number:'1.0-0' }}</p>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-icons stat-icon">request_quote</span>
        <div class="stat-content">
          <h3>Comisión</h3>
          <p class="stat-value">${{ reporteComisiones.totalComision | number:'1.0-0' }}</p>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-icons stat-icon">receipt</span>
        <div class="stat-content">
          <h3>IVA Comisión</h3>
          <p class="stat-value">${{ reporteComisiones.totalIVA | number:'1.0-0' }}</p>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-icons stat-icon">account_balance_wallet</span>
        <div class="stat-content">
          <h3>Neto</h3>
          <p class="stat-value">${{ reporteComisiones.totalNeto | number:'1.0-0' }}</p>
        </div>
      </div>
    </div>

    <div class="report-section">
      <h3>Detalle por Evento</h3>
      <div class="table-wrapper">
        <table class="report-table">
          <thead>
            <tr>
              <th>Evento</th>
              <th>Transacciones</th>
              <th>Bruto</th>
              <th>Comisión</th>
              <th>IVA</th>
              <th>Neto</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let ev of reporteComisiones.porEvento">
              <td>{{ ev.eventoTitulo }}</td>
              <td>{{ ev.transacciones }}</td>
              <td>${{ ev.bruto | number:'1.0-0' }}</td>
              <td>${{ ev.comision | number:'1.0-0' }}</td>
              <td>${{ ev.iva | number:'1.0-0' }}</td>
              <td>${{ ev.neto | number:'1.0-0' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Reporte de Eventos -->
  <div *ngIf="!loading && reporteEventos" class="content-card">
    <h2>
      <span class="material-icons">event</span>
      Reporte de Eventos
    </h2>
    
    <div class="stats-grid">
      <div class="stat-card">
        <span class="material-icons stat-icon">event</span>
        <div class="stat-content">
          <h3>Total Eventos</h3>
          <p class="stat-value">{{ reporteEventos.totalEventos }}</p>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-icons stat-icon">check_circle</span>
        <div class="stat-content">
          <h3>Eventos Activos</h3>
          <p class="stat-value">{{ reporteEventos.eventosActivos }}</p>
        </div>
      </div>
      <div class="stat-card">
        <span class="material-icons stat-icon">star</span>
        <div class="stat-content">
          <h3>Eventos Destacados</h3>
          <p class="stat-value">{{ reporteEventos.eventosDestacados }}</p>
        </div>
      </div>
    </div>

    <div class="report-section">
      <h3>Eventos por Estado</h3>
      <div class="chart-data">
        <div *ngFor="let item of reporteEventos.eventosPorEstado | keyvalue" class="chart-item">
          <span class="chart-label">{{ item.key }}</span>
          <span class="chart-value">{{ item.value }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="content-card">
    <div class="export-section">
      <h3>
        <span class="material-icons">download</span>
        Exportar Reportes
      </h3>
      <p class="export-description">
        Descarga un reporte completo en formato Excel con todas las estadísticas y datos detallados.
      </p>
      <button 
        class="btn-primary" 
        (click)="exportarReporte()"
        [disabled]="loading || (!reporteVentas && !reporteEventos)">
        <span class="material-icons">download</span>
        Exportar a Excel
      </button>
    </div>
  </div>
</div>
