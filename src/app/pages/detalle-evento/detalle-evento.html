<div class="detalle-evento-page">
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando evento...</p>
  </div>

  <div *ngIf="!loading && evento" class="evento-detalle">
    <!-- Botón volver -->
    <button class="btn-back" (click)="router.navigate(['/eventos-cliente'])">
      <span class="material-icons">arrow_back</span>
      Volver a Eventos
    </button>

    <!-- Header del evento -->
    <div class="evento-header">
      <div class="evento-image-large">
        <div class="evento-image-background" *ngIf="evento">
          <img [src]="getImageUrl(evento)" [alt]="evento.titulo" />
        </div>
        <div class="image-collage">
          <div class="collage-item collage-item-1" (click)="abrirImagenModal()">
            <img [src]="getImageUrl(evento)" [alt]="evento.titulo" />
          </div>
          <div class="collage-item collage-item-2" (click)="abrirImagenModal()">
            <img [src]="getImageUrl(evento)" [alt]="evento.titulo" />
          </div>
          <div class="collage-item collage-item-3" (click)="abrirImagenModal()">
            <img [src]="getImageUrl(evento)" [alt]="evento.titulo" />
          </div>
        </div>
        <div class="evento-badge" *ngIf="evento.destacado">
          <span class="material-icons">star</span>
          Destacado
        </div>
      </div>
      <div class="evento-info-header">
        <div class="evento-title-section">
          <h1>{{ evento.titulo }}</h1>
          <div class="evento-badges">
            <span class="badge badge-categoria" *ngIf="categoria"
              [style.background-color]="categoria.color || '#667eea'">
              <ion-icon [name]="getCategoryIcon(categoria)"></ion-icon>
              {{ categoria.nombre }}
            </span>
            <span class="badge badge-destacado" *ngIf="evento.destacado">
              <span class="material-icons">star</span>
              Destacado
            </span>
          </div>
        </div>
        <p *ngIf="evento.descripcion_corta" class="evento-subtitle">{{ evento.descripcion_corta }}</p>
        <div class="evento-meta">
          <div class="meta-item">
            <span class="material-icons">calendar_today</span>
            <div>
              <strong>Fecha de inicio:</strong>
              <span>{{ evento.fecha_inicio | dateFormat:'full' }}</span>
            </div>
          </div>
          <div class="meta-item">
            <span class="material-icons">event</span>
            <div>
              <strong>Fecha de fin:</strong>
              <span>{{ evento.fecha_fin | dateFormat:'full' }}</span>
            </div>
          </div>
          <div class="meta-item" *ngIf="evento.fecha_venta_inicio">
            <span class="material-icons">shopping_cart</span>
            <div>
              <strong>Venta inicia:</strong>
              <span>{{ evento.fecha_venta_inicio | dateFormat:'medium' }}</span>
            </div>
          </div>
          <div class="meta-item" *ngIf="evento.fecha_venta_fin">
            <span class="material-icons">schedule</span>
            <div>
              <strong>Venta termina:</strong>
              <span>{{ evento.fecha_venta_fin | dateFormat:'medium' }}</span>
            </div>
          </div>
          <div class="meta-item" *ngIf="evento.edad_minima && evento.edad_minima > 0">
            <span class="material-icons">person</span>
            <div>
              <strong>Edad mínima:</strong>
              <span>+{{ evento.edad_minima }} años</span>
            </div>
          </div>
          <div class="meta-item">
            <span class="material-icons">attach_money</span>
            <div>
              <strong>Precio:</strong>
              <span *ngIf="evento.es_gratis" class="precio-gratis">Gratis</span>
              <span *ngIf="!evento.es_gratis && evento.precio_minimo && evento.precio_maximo">
                {{ formatCurrency(evento.precio_minimo) }} - {{ formatCurrency(evento.precio_maximo) }}
              </span>
              <span *ngIf="!evento.es_gratis && evento.precio_minimo && !evento.precio_maximo">
                Desde {{ formatCurrency(evento.precio_minimo) }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Información del Lugar -->
    <div class="evento-section evento-accordion" *ngIf="lugar || loadingLugar">
      <button class="accordion-header" (click)="toggleAcordeon('ubicacion')" type="button">
        <h2>
          <span class="material-icons">place</span>
          Ubicación del Evento
        </h2>
        <span class="material-icons accordion-icon" [class.open]="acordeones.ubicacion">expand_more</span>
      </button>
      <div class="accordion-content" [class.open]="acordeones.ubicacion">
        <div *ngIf="loadingLugar" class="loading-small">
          <p>Cargando información del lugar...</p>
        </div>
        <div *ngIf="!loadingLugar && lugar" class="lugar-info">
          <div class="lugar-header">
            <h3>{{ lugar.nombre }}</h3>
          </div>
          <div class="lugar-details">
            <div class="lugar-item">
              <span class="material-icons">location_on</span>
              <div class="lugar-item-content">
                <strong>Dirección</strong>
                <p>{{ lugar.direccion }}</p>
              </div>
            </div>
            <div class="lugar-item" *ngIf="lugar.ciudad">
              <span class="material-icons">location_city</span>
              <div class="lugar-item-content">
                <strong>Ciudad</strong>
                <p>{{ lugar.ciudad }}<span *ngIf="lugar.pais">, {{ lugar.pais }}</span></p>
              </div>
            </div>
            <div class="lugar-item" *ngIf="lugar.telefono">
              <span class="material-icons">phone</span>
              <div class="lugar-item-content">
                <strong>Teléfono</strong>
                <p>{{ lugar.telefono }}</p>
              </div>
            </div>
            <div class="lugar-item" *ngIf="lugar.email">
              <span class="material-icons">email</span>
              <div class="lugar-item-content">
                <strong>Email</strong>
                <p>{{ lugar.email }}</p>
              </div>
            </div>
            <div class="lugar-item" *ngIf="lugar.capacidad_maxima">
              <span class="material-icons">people</span>
              <div class="lugar-item-content">
                <strong>Capacidad</strong>
                <p>{{ lugar.capacidad_maxima }} personas</p>
              </div>
            </div>
            <div class="lugar-item" *ngIf="lugar.descripcion">
              <span class="material-icons">description</span>
              <div class="lugar-item-content">
                <strong>Descripción</strong>
                <p>{{ lugar.descripcion }}</p>
              </div>
            </div>
            <div class="lugar-buttons" *ngIf="lugar.latitud && lugar.longitud || lugar.sitio_web">
              <button type="button" class="btn-google-maps" *ngIf="lugar.latitud && lugar.longitud"
                (click)="abrirGoogleMaps(lugar.latitud, lugar.longitud)">
                <span class="material-icons">map</span>
                <span>Ver en Google Maps</span>
              </button>
              <button type="button" class="btn-sitio-web" *ngIf="lugar.sitio_web"
                (click)="abrirSitioWeb(lugar.sitio_web)">
                <span class="material-icons">language</span>
                <span>Visitar Sitio Web</span>
              </button>
            </div>
          </div>
        </div>
        <div *ngIf="!loadingLugar && !lugar && evento.lugar_id" class="error-message">
          <span class="material-icons">error</span>
          <p>No se pudo cargar la información del lugar</p>
        </div>
      </div>
    </div>

    <!-- Descripción -->
    <div class="evento-section evento-accordion" *ngIf="evento.descripcion">
      <button class="accordion-header" (click)="toggleAcordeon('descripcion')" type="button">
        <h2>
          <span class="material-icons">description</span>
          Descripción
        </h2>
        <span class="material-icons accordion-icon" [class.open]="acordeones.descripcion">expand_more</span>
      </button>
      <div class="accordion-content" [class.open]="acordeones.descripcion">
        <p class="evento-descripcion">{{ evento.descripcion }}</p>
      </div>
    </div>

    <!-- Video de YouTube -->
    <div class="evento-section" *ngIf="evento.url_video && getYoutubeEmbedUrl(evento.url_video)">
      <h2>
        <span class="material-icons">play_circle</span>
        Video del Evento
      </h2>
      <div class="video-container">
        <iframe 
          [src]="getYoutubeEmbedUrl(evento.url_video) | safe" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen
          class="youtube-embed">
        </iframe>
      </div>
    </div>

    <!-- Tags -->
    <div class="evento-section evento-accordion" *ngIf="evento.tags">
      <button class="accordion-header" (click)="toggleAcordeon('tags')" type="button">
        <h2>
          <span class="material-icons">label</span>
          Etiquetas
        </h2>
        <span class="material-icons accordion-icon" [class.open]="acordeones.tags">expand_more</span>
      </button>
      <div class="accordion-content" [class.open]="acordeones.tags">
        <div class="tags-container">
          <span *ngFor="let tag of getTags()" class="tag">{{ tag }}</span>
        </div>
      </div>
    </div>

    <!-- Términos y Condiciones -->
    <div class="evento-section evento-accordion" *ngIf="evento.terminos_condiciones">
      <button class="accordion-header" (click)="toggleAcordeon('terminos')" type="button">
        <h2>
          <span class="material-icons">gavel</span>
          Términos y Condiciones
        </h2>
        <span class="material-icons accordion-icon" [class.open]="acordeones.terminos">expand_more</span>
      </button>
      <div class="accordion-content" [class.open]="acordeones.terminos">
        <div class="evento-descripcion">{{ evento.terminos_condiciones }}</div>
      </div>
    </div>

    <!-- Política de Reembolso -->
    <div class="evento-section evento-accordion" *ngIf="evento.politica_reembolso">
      <button class="accordion-header" (click)="toggleAcordeon('politica')" type="button">
        <h2>
          <span class="material-icons">undo</span>
          Política de Reembolso
        </h2>
        <span class="material-icons accordion-icon" [class.open]="acordeones.politica">expand_more</span>
      </button>
      <div class="accordion-content" [class.open]="acordeones.politica">
        <div class="evento-descripcion">{{ evento.politica_reembolso }}</div>
      </div>
    </div>

    <!-- Tipos de boleta disponibles -->
    <div class="evento-section" *ngIf="!isEventoFinalizado()">
      <h2>Boletas Disponibles</h2>
      <div *ngIf="loadingBoletas" class="loading-small">
        <p>Cargando tipos de boleta...</p>
      </div>
      <div *ngIf="!loadingBoletas && tiposBoleta.length > 0" class="tipos-boleta-grid">
        <div *ngFor="let tipo of tiposBoleta" class="tipo-boleta-card">
          <div class="tipo-boleta-header">
            <h3>{{ tipo.nombre }}</h3>
            <span class="precio">{{ formatCurrency(tipo.precio) }}</span>
          </div>
          <p *ngIf="tipo.descripcion" class="tipo-descripcion">{{ tipo.descripcion }}</p>
          <div class="tipo-info">
            <span class="disponibles">{{ tipo.cantidad_disponibles }} disponibles</span>
            <span *ngIf="tipo.cantidad_vendidas !== undefined && tipo.cantidad_vendidas > 0" class="vendidas">{{ tipo.cantidad_vendidas }} vendidas de {{ tipo.cantidad_total }} totales</span>
            <span *ngIf="tipo.limite_por_persona" class="limite">Máx. {{ tipo.limite_por_persona }} por persona</span>
          </div>
          <div class="tipo-actions">
            <div class="cantidad-controls" *ngIf="getCantidadEnCarrito(tipo) > 0">
              <button class="btn-cantidad" (click)="quitarDelCarrito(tipo)">-</button>
              <span class="cantidad">{{ getCantidadEnCarrito(tipo) }}</span>
              <button class="btn-cantidad" (click)="agregarAlCarrito(tipo)"
                [disabled]="getCantidadEnCarrito(tipo) >= tipo.cantidad_disponibles">+</button>
              <button class="btn-remove" (click)="eliminarDelCarrito(tipo)">
                <span class="material-icons">delete</span>
              </button>
            </div>
            <button *ngIf="getCantidadEnCarrito(tipo) === 0" class="btn-add" (click)="agregarAlCarrito(tipo)"
              [disabled]="tipo.cantidad_disponibles === 0">
              <span class="material-icons">add_shopping_cart</span>
              Agregar
            </button>
          </div>
        </div>
      </div>
      <div *ngIf="!loadingBoletas && tiposBoleta.length === 0" class="empty-state">
        <p>No hay boletas disponibles para este evento</p>
      </div>
    </div>

    <!-- Mensaje si el evento está finalizado -->
    <div class="evento-section evento-accordion" *ngIf="isEventoFinalizado()">
      <button class="accordion-header" (click)="toggleAcordeon('eventoFinalizado')" type="button">
        <h2>
          <span class="material-icons">event_busy</span>
          Evento Finalizado
        </h2>
        <span class="material-icons accordion-icon" [class.open]="acordeones.eventoFinalizado">expand_more</span>
      </button>
      <div class="accordion-content" [class.open]="acordeones.eventoFinalizado">
        <div class="evento-finalizado-message">
          <p>Este evento ya finalizó. Las boletas ya no están disponibles para compra.</p>
        </div>
      </div>
    </div>

    <!-- Carrito de compra -->
    <div class="evento-section" *ngIf="itemsCompra.length > 0 && !isEventoFinalizado()">
      <h2>Mi Carrito</h2>
      <div class="carrito-items">
        <div *ngFor="let item of itemsCompra" class="carrito-item">
          <div class="carrito-item-info">
            <div class="info-main">
              <h4>{{ item.tipo.nombre }}</h4>
              <p class="carrito-precio">{{ formatCurrency(item.tipo.precio) }} x {{ item.cantidad }}</p>
            </div>
            <div class="info-side">
              <p class="carrito-subtotal">Subtotal: {{ formatCurrency(item.tipo.precio * item.cantidad) }}</p>
              <button class="btn-remove-item-static" (click)="eliminarDelCarrito(item.tipo)" title="Quitar item">
                <span class="material-icons">delete</span>
              </button>
            </div>
          </div>
          <div class="carrito-item-datos">
            <div class="datos-header">
              <h5>Datos del Asistente</h5>
              <button type="button" class="btn-usar-datos" (click)="usarMisDatos(item)" *ngIf="usuario"
                title="Usar mis datos del perfil">
                <span class="material-icons">person</span>
                Usar mis datos
              </button>
            </div>
            <div class="form-group-small">
              <label>Nombre del asistente *</label>
              <input type="text" [(ngModel)]="item.datosAsistente.nombre" placeholder="Nombre completo" />
            </div>
            <div class="form-group-small">
              <label>Documento *</label>
              <input type="text" [(ngModel)]="item.datosAsistente.documento" placeholder="Número de documento" />
            </div>
            <div class="form-group-small">
              <label>Email</label>
              <input type="email" [(ngModel)]="item.datosAsistente.email" placeholder="email@ejemplo.com" />
            </div>
            <div class="form-group-small">
              <label>Teléfono</label>
              <input type="tel" [(ngModel)]="item.datosAsistente.telefono" placeholder="300 123 4567" />
            </div>
          </div>
        </div>
      </div>
      
      <!-- Cupón de Descuento -->
      <div class="cupon-section">
        <h5>¿Tienes un cupón de descuento?</h5>
        <div class="cupon-input-group" *ngIf="!cuponAplicado">
          <input type="text" [(ngModel)]="codigoCupon" placeholder="Ingresa el código" (keyup.enter)="aplicarCupon()" />
          <button class="btn-aplicar-cupon" (click)="aplicarCupon()" [disabled]="validandoCupon || !codigoCupon">
            {{ validandoCupon ? 'Validando...' : 'Aplicar' }}
          </button>
        </div>
        <div class="cupon-aplicado" *ngIf="cuponAplicado">
          <div class="cupon-info">
            <span class="material-icons">confirmation_number</span>
            <span>Cupón <strong>{{ cuponAplicado.codigo }}</strong> aplicado ({{ cuponAplicado.porcentaje_descuento }}% de descuento)</span>
          </div>
          <button class="btn-quitar-cupon" (click)="quitarCupon()" title="Quitar cupón">
            <span class="material-icons">close</span>
          </button>
        </div>
      </div>

      <div class="carrito-total">
        <div class="total-info">
          <div class="total-row" *ngIf="cuponAplicado">
            <span>Subtotal:</span>
            <span>{{ formatCurrency(getSubtotal()) }}</span>
          </div>
          <div class="total-row descuento" *ngIf="cuponAplicado">
            <span>Descuento ({{ cuponAplicado.porcentaje_descuento }}%):</span>
            <span>-{{ formatCurrency(getDescuento()) }}</span>
          </div>
          <div class="total-row main">
            <h3>Total: {{ formatCurrency(getTotal()) }}</h3>
          </div>
        </div>
        <button class="btn-comprar" (click)="procesarCompra()" [disabled]="comprando">
          <span class="material-icons">{{ comprando ? 'hourglass_empty' : 'shopping_cart' }}</span>
          {{ comprando ? 'Procesando...' : 'Comprar Boletas' }}
        </button>
        <p class="wompi-info">Serás redirigido a Wompi para completar el pago de forma segura</p>
      </div>
    </div>
  </div>

  <!-- Modal de imagen -->
  <div class="image-modal" *ngIf="imagenModalAbierta && evento" (click)="cerrarImagenModal()">
    <div class="image-modal-content" (click)="$event.stopPropagation()">
      <button class="image-modal-close" (click)="cerrarImagenModal()" type="button">
        <span class="material-icons">close</span>
      </button>
      <img [src]="getImageUrl(evento)" [alt]="evento.titulo" />
    </div>
  </div>
</div>