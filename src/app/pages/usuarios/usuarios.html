<div class="usuarios-page">
  <header class="page-header">
    <div>
      <h1>
        <span class="material-icons">people</span>
        Usuarios
      </h1>
      <p>Gestiona todos los usuarios del sistema</p>
    </div>
    <button class="btn-primary" (click)="openModal()">
      <span class="material-icons">add</span>
      Nuevo Usuario
    </button>
  </header>

  <!-- Filtros -->
  <div class="filters-card">
    <div class="filter-group">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="loadUsuarios()"
        placeholder="Buscar por email, nombre..."
        class="search-input"
      />
    </div>
    <div class="filter-group">
      <select [(ngModel)]="tipoFiltro" (ngModelChange)="loadUsuarios()" class="select-input">
        <option [value]="null">Todos los tipos</option>
        <option *ngFor="let tipo of tiposUsuario" [value]="tipo.id">{{ tipo.nombre }}</option>
      </select>
    </div>
    <div class="filter-group">
      <select [(ngModel)]="activoFiltro" (ngModelChange)="loadUsuarios()" class="select-input">
        <option [value]="null">Todos</option>
        <option [value]="true">Activos</option>
        <option [value]="false">Inactivos</option>
      </select>
    </div>
  </div>

  <!-- Tabla -->
  <div class="content-card">
    <div *ngIf="loading" class="loading-state">Cargando usuarios...</div>
    
    <table *ngIf="!loading && usuarios.length > 0" class="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Email Verificado</th>
          <th>Fecha Creación</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let usuario of usuarios">
          <td>{{ usuario.id }}</td>
          <td>{{ usuario.email }}</td>
          <td>{{ usuario.nombre }} {{ usuario.apellido }}</td>
          <td>{{ getTipoNombre(usuario.tipo_usuario_id) }}</td>
          <td>
            <span [class]="usuario.activo ? 'badge-success' : 'badge-danger'">
              {{ usuario.activo ? 'Activo' : 'Inactivo' }}
            </span>
          </td>
          <td>
            <span [class]="usuario.email_verificado ? 'badge-success' : 'badge-warning'">
              {{ usuario.email_verificado ? 'Sí' : 'No' }}
            </span>
          </td>
          <td>{{ usuario.fecha_creacion | dateFormat:'short' }}</td>
          <td class="actions">
            <button class="btn-icon" (click)="openModal(usuario)" title="Editar">
              <span class="material-icons">edit</span>
            </button>
            <button class="btn-icon" (click)="toggleActivo(usuario)" [title]="usuario.activo ? 'Desactivar' : 'Activar'">
              <span class="material-icons">{{ usuario.activo ? 'block' : 'check_circle' }}</span>
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!loading && usuarios.length === 0" class="empty-state">
      No se encontraron usuarios
    </div>

    <!-- Paginación -->
    <div *ngIf="total > limit" class="pagination">
      <div class="pagination-info">
        <span>Mostrando {{ (page - 1) * limit + 1 }} - {{ Math.min(page * limit, total) }} de {{ total }} resultados</span>
      </div>
      <div class="pagination-controls">
        <button 
          class="pagination-btn" 
          (click)="goToPage(1)" 
          [disabled]="page === 1"
          title="Primera página"
        >
          <span class="material-icons">first_page</span>
        </button>
        <button 
          class="pagination-btn" 
          (click)="goToPage(page - 1)" 
          [disabled]="page === 1"
          title="Página anterior"
        >
          <span class="material-icons">chevron_left</span>
        </button>
        
        <div class="pagination-numbers">
          <button
            *ngFor="let pageNum of getPageNumbers()"
            class="pagination-number"
            [class.active]="pageNum === page"
            (click)="goToPage(pageNum)"
          >
            {{ pageNum }}
          </button>
        </div>
        
        <button 
          class="pagination-btn" 
          (click)="goToPage(page + 1)" 
          [disabled]="page >= getTotalPages()"
          title="Página siguiente"
        >
          <span class="material-icons">chevron_right</span>
        </button>
        <button 
          class="pagination-btn" 
          (click)="goToPage(getTotalPages())" 
          [disabled]="page >= getTotalPages()"
          title="Última página"
        >
          <span class="material-icons">last_page</span>
        </button>
      </div>
      <div class="pagination-page-info">
        <span>Página {{ page }} de {{ getTotalPages() }}</span>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingUsuario ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
        <button class="btn-close" (click)="closeModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Email <span style="color: red;">*</span></label>
          <input type="email" [(ngModel)]="formData.email" [disabled]="!!editingUsuario" required />
        </div>
        <div class="form-group" *ngIf="!editingUsuario">
          <label>Contraseña <span style="color: red;">*</span></label>
          <input type="password" [(ngModel)]="password" placeholder="Mínimo 6 caracteres" required />
          <small style="color: #666; font-size: 0.85em;">La contraseña debe tener al menos 6 caracteres</small>
        </div>
        <div class="form-group">
          <label>Nombre</label>
          <input type="text" [(ngModel)]="formData.nombre" />
        </div>
        <div class="form-group">
          <label>Apellido</label>
          <input type="text" [(ngModel)]="formData.apellido" />
        </div>
        <div class="form-group">
          <label>Tipo de Usuario <span style="color: red;">*</span></label>
          <select [(ngModel)]="formData.tipo_usuario_id" required>
            <option [value]="null">Seleccione un tipo</option>
            <option *ngFor="let tipo of tiposUsuario" [value]="tipo.id">{{ tipo.nombre }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Teléfono</label>
          <input type="tel" [(ngModel)]="formData.telefono" />
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" [(ngModel)]="formData.activo" />
            Activo
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button class="btn-primary" (click)="saveUsuario()">Guardar</button>
      </div>
    </div>
  </div>
</div>
