<div class="ventas-page">
  <header class="page-header">
    <div>
      <h1>
        <span class="material-icons">attach_money</span>
        Ventas
      </h1>
      <p>Revisa y gestiona todas las ventas del sistema</p>
    </div>
  </header>

  <!-- Filtros -->
  <div class="filters-card">
    <select [(ngModel)]="estadoPagoFiltro" (ngModelChange)="loadCompras()" class="select-input">
      <option [value]="null">Todos los estados de pago</option>
      <option *ngFor="let estado of estadosPago" [value]="estado.value">{{ estado.label }}</option>
    </select>
    <select [(ngModel)]="estadoCompraFiltro" (ngModelChange)="loadCompras()" class="select-input">
      <option [value]="null">Todos los estados de compra</option>
      <option *ngFor="let estado of estadosCompra" [value]="estado.value">{{ estado.label }}</option>
    </select>
  </div>

  <!-- Tabla de ventas -->
  <div class="content-card">
    <div *ngIf="loading" class="loading-state">Cargando ventas...</div>
    
    <table *ngIf="!loading && compras.length > 0" class="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Transacción</th>
          <th>Cliente</th>
          <th>Evento</th>
          <th>Subtotal</th>
          <th>Descuento</th>
          <th>Total</th>
          <th>Método Pago</th>
          <th>Estado Pago</th>
          <th>Estado Compra</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let compra of compras">
          <td>{{ compra.id }}</td>
          <td>{{ compra.numero_transaccion }}</td>
          <td>
            <button class="btn-link" (click)="openClienteModal(compra)" title="Ver detalles del cliente">
              {{ getClienteNombre(compra) }}
            </button>
          </td>
          <td>
            <button class="btn-link" (click)="openEventoModal(compra)" title="Ver detalles del evento">
              {{ getEventoTitulo(compra) }}
            </button>
          </td>
          <td>${{ (compra.subtotal || compra.total) | number:'1.2-2' }}</td>
          <td>
            <div *ngIf="compra.descuento_total && compra.descuento_total > 0" class="discount-cell">
              <span class="discount-amount">-${{ compra.descuento_total | number:'1.2-2' }}</span>
              <small class="coupon-code" *ngIf="compra.cupon">({{ compra.cupon.codigo }})</small>
            </div>
            <span *ngIf="!compra.descuento_total || compra.descuento_total === 0">-</span>
          </td>
          <td><strong>${{ compra.total | number:'1.2-2' }}</strong></td>
          <td>{{ compra.metodo_pago }}</td>
          <td>
            <span [class]="compra.estado_pago === 'completado' ? 'badge-success' : 'badge-warning'">
              {{ getEstadoPagoLabel(compra.estado_pago) }}
            </span>
          </td>
          <td>
            <span [class]="compra.estado_compra === 'confirmada' ? 'badge-success' : 'badge-warning'">
              {{ getEstadoCompraLabel(compra.estado_compra) }}
            </span>
          </td>
          <td>{{ compra.fecha_compra | dateFormat:'short' }}</td>
          <td class="actions">
            <button class="btn-icon" (click)="openModal(compra)" title="Editar">
              <span class="material-icons">edit</span>
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!loading && compras.length === 0" class="empty-state">
      No hay ventas registradas. ¡Cuando comiences a vender boletas, aparecerán aquí!
    </div>

    <!-- Paginación -->
    <div *ngIf="total > limit" class="pagination">
      <div class="pagination-info">
        <span>Mostrando {{ (page - 1) * limit + 1 }} - {{ Math.min(page * limit, total) }} de {{ total }} resultados</span>
      </div>
      <div class="pagination-controls">
        <button 
          class="pagination-btn" 
          (click)="goToPage(1)" 
          [disabled]="page === 1"
          title="Primera página"
        >
          <span class="material-icons">first_page</span>
        </button>
        <button 
          class="pagination-btn" 
          (click)="goToPage(page - 1)" 
          [disabled]="page === 1"
          title="Página anterior"
        >
          <span class="material-icons">chevron_left</span>
        </button>
        
        <div class="pagination-numbers">
          <button
            *ngFor="let pageNum of getPageNumbers()"
            class="pagination-number"
            [class.active]="pageNum === page"
            (click)="goToPage(pageNum)"
          >
            {{ pageNum }}
          </button>
        </div>
        
        <button 
          class="pagination-btn" 
          (click)="goToPage(page + 1)" 
          [disabled]="page >= getTotalPages()"
          title="Página siguiente"
        >
          <span class="material-icons">chevron_right</span>
        </button>
        <button 
          class="pagination-btn" 
          (click)="goToPage(getTotalPages())" 
          [disabled]="page >= getTotalPages()"
          title="Última página"
        >
          <span class="material-icons">last_page</span>
        </button>
      </div>
      <div class="pagination-page-info">
        <span>Página {{ page }} de {{ getTotalPages() }}</span>
      </div>
    </div>
  </div>

  <!-- Modal Editar Compra -->
  <div *ngIf="showModal" class="modal-overlay">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Editar Compra</h2>
        <button class="btn-close" (click)="closeModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="financial-summary" *ngIf="formData.id">
          <div class="summary-item">
            <label>Subtotal:</label>
            <span>${{ (formData.subtotal || formData.total) | number:'1.2-2' }}</span>
          </div>
          <div class="summary-item" *ngIf="formData.descuento_total && formData.descuento_total > 0">
            <label>Descuento:</label>
            <span class="discount-text">-${{ formData.descuento_total | number:'1.2-2' }} <small *ngIf="formData.cupon">({{ formData.cupon.codigo }})</small></span>
          </div>
          <div class="summary-item total">
            <label>Total:</label>
            <span>${{ formData.total | number:'1.2-2' }}</span>
          </div>
        </div>
        
        <div class="form-group">
          <label>Estado de Pago</label>
          <select [(ngModel)]="formData.estado_pago">
            <option *ngFor="let estado of estadosPago" [value]="estado.value">{{ estado.label }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Estado de Compra</label>
          <select [(ngModel)]="formData.estado_compra">
            <option *ngFor="let estado of estadosCompra" [value]="estado.value">{{ estado.label }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Motivo de Cancelación</label>
          <textarea [(ngModel)]="formData.motivo_cancelacion" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Notas</label>
          <textarea [(ngModel)]="formData.notas" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button class="btn-primary" (click)="saveCompra()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Detalles Cliente -->
  <div *ngIf="showClienteModal" class="modal-overlay">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <span class="material-icons">person</span>
          Detalles del Cliente
        </h2>
        <button class="btn-close" (click)="closeClienteModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body" *ngIf="selectedCliente">
        <div class="detail-group">
          <label>ID:</label>
          <span>{{ selectedCliente.id }}</span>
        </div>
        <div class="detail-group">
          <label>Nombre:</label>
          <span>{{ selectedCliente.nombre || 'N/A' }}</span>
        </div>
        <div class="detail-group">
          <label>Apellido:</label>
          <span>{{ selectedCliente.apellido || 'N/A' }}</span>
        </div>
        <div class="detail-group">
          <label>Email:</label>
          <span>{{ selectedCliente.email }}</span>
        </div>
        <div class="detail-group">
          <label>Teléfono:</label>
          <span>{{ selectedCliente.telefono || 'N/A' }}</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-primary" (click)="closeClienteModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Detalles Evento -->
  <div *ngIf="showEventoModal" class="modal-overlay">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          <span class="material-icons">event</span>
          Detalles del Evento
        </h2>
        <button class="btn-close" (click)="closeEventoModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body" *ngIf="selectedEvento">
        <div class="detail-group">
          <label>ID:</label>
          <span>{{ selectedEvento.id }}</span>
        </div>
        <div class="detail-group">
          <label>Título:</label>
          <span>{{ selectedEvento.titulo }}</span>
        </div>
        <div class="detail-group">
          <label>Fecha de Inicio:</label>
          <span>{{ selectedEvento.fecha_inicio | dateFormat:'short' }}</span>
        </div>
        
        <div class="detail-group" *ngIf="selectedEvento.lugar">
          <label style="font-size: var(--font-size-lg); margin-top: var(--spacing-md); margin-bottom: var(--spacing-sm);">
            <span class="material-icons" style="vertical-align: middle; font-size: 1.2rem;">place</span>
            Lugar
          </label>
          <div style="padding: var(--spacing-md); background: var(--color-background); border-radius: var(--border-radius-sm); border-left: 3px solid var(--color-secondary);">
            <div class="detail-group" style="margin-bottom: var(--spacing-sm);">
              <label>Nombre:</label>
              <span>{{ selectedEvento.lugar.nombre }}</span>
            </div>
            <div class="detail-group" style="margin-bottom: var(--spacing-sm);">
              <label>Dirección:</label>
              <span>{{ selectedEvento.lugar.direccion }}</span>
            </div>
            <div class="detail-group" style="margin-bottom: var(--spacing-sm);">
              <label>Ciudad:</label>
              <span>{{ selectedEvento.lugar.ciudad }}</span>
            </div>
            <div class="detail-group" style="margin-bottom: var(--spacing-sm);" *ngIf="selectedEvento.lugar.pais">
              <label>País:</label>
              <span>{{ selectedEvento.lugar.pais }}</span>
            </div>
            <div class="detail-group" style="margin-bottom: var(--spacing-sm);" *ngIf="selectedEvento.lugar.telefono">
              <label>Teléfono:</label>
              <span>{{ selectedEvento.lugar.telefono }}</span>
            </div>
            <div class="detail-group" style="margin-bottom: 0;" *ngIf="selectedEvento.lugar.email">
              <label>Email:</label>
              <span>{{ selectedEvento.lugar.email }}</span>
            </div>
          </div>
        </div>
        <div class="detail-group" *ngIf="!selectedEvento.lugar && selectedEvento.lugar_id">
          <label>Lugar ID:</label>
          <span>{{ selectedEvento.lugar_id }} (Información no disponible)</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-primary" (click)="closeEventoModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>
