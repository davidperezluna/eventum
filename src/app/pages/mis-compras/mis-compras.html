<div class="mis-compras-page">
  <!-- Hero Section (Mini) -->
  <section class="hero-section mini-hero">
    <div class="hero-content">
      <h1 class="hero-title">Mis <span class="gradient-text">Compras</span></h1>
      <p class="hero-subtitle">Historial de tus experiencias y boletas adquiridas</p>
    </div>
  </section>

  <!-- Filtros -->
  <div class="filters-card">
    <div class="filters-row">
      <div class="filter-group">
        <label>Estado de Pago</label>
        <select [(ngModel)]="estadoPagoFiltro" (ngModelChange)="loadCompras()" class="select-input">
          <option [value]="null">Todos</option>
          <option *ngFor="let estado of estadosPago" [value]="estado.value">{{ estado.label }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Estado de Compra</label>
        <select [(ngModel)]="estadoCompraFiltro" (ngModelChange)="loadCompras()" class="select-input">
          <option [value]="null">Todos</option>
          <option *ngFor="let estado of estadosCompra" [value]="estado.value">{{ estado.label }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Evento</label>
        <select [(ngModel)]="eventoFiltro" (ngModelChange)="loadCompras()" class="select-input"
          [disabled]="loadingEventos">
          <option [value]="null">Todos los eventos</option>
          <option *ngFor="let evento of eventosDisponibles" [value]="evento.id">
            {{ evento.titulo }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label>Fecha Desde</label>
        <input type="date" [(ngModel)]="fechaDesde" (ngModelChange)="loadCompras()" class="input-field" />
      </div>

      <div class="filter-group">
        <label>Fecha Hasta</label>
        <input type="date" [(ngModel)]="fechaHasta" (ngModelChange)="loadCompras()" class="input-field" />
      </div>

      <div class="filter-group filter-search">
        <label>Buscar Transacción</label>
        <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="loadCompras()"
          placeholder="Número de transacción..." class="input-field" />
      </div>

      <div class="filter-actions">
        <button class="btn-clear" (click)="limpiarFiltros()" type="button">
          <span class="material-icons">clear</span>
          Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando compras...</p>
  </div>

  <!-- Lista de compras -->
  <div *ngIf="!loading && comprasConBoletas.length > 0" class="compras-list">
    <div *ngFor="let item of comprasConBoletas" class="compra-card">
      <div class="compra-header">
        <div class="compra-info">
          <h3>Compra #{{ item.compra.numero_transaccion }}</h3>
          <p class="compra-fecha">{{ item.compra.fecha_compra | dateFormat:'full' }}</p>
          <div class="compra-estados">
            <span class="badge" [class]="getEstadoClass(item.compra.estado_pago)">
              Pago: {{ getEstadoPagoLabel(item.compra.estado_pago) }}
            </span>
            <span class="badge" [class]="getEstadoClass(item.compra.estado_compra)">
              Estado: {{ getEstadoCompraLabel(item.compra.estado_compra) }}
            </span>
          </div>
        </div>
        <div class="compra-total">
          <span class="total-label">Total</span>
          <span class="total-value">{{ formatCurrency(item.compra.total) }}</span>
        </div>
      </div>

      <!-- Boletas de la compra -->
      <div class="boletas-section" *ngIf="item.boletas.length > 0">
        <h4>Boletas ({{ item.boletas.length }})</h4>
        <div class="boletas-grid">
          <div *ngFor="let boleta of item.boletas" class="boleta-card">
            <div class="boleta-header">
              <div class="boleta-info">
                <span class="boleta-codigo" *ngIf="item.compra.estado_pago === 'completado'">Código: {{ boleta.codigo_qr }}</span>
                <span class="boleta-codigo" *ngIf="item.compra.estado_pago !== 'completado'">Código: ******</span>
                <span class="boleta-precio">{{ formatCurrency(boleta.precio_unitario) }}</span>
              </div>
              <span class="badge" [class]="getEstadoClass(boleta.estado)">
                {{ getEstadoBoletaLabel(boleta.estado) }}
              </span>
            </div>
            <div class="boleta-datos" *ngIf="boleta.nombre_asistente">
              <p><strong>Asistente:</strong> {{ boleta.nombre_asistente }}</p>
              <p *ngIf="boleta.documento_asistente"><strong>Documento:</strong> {{ boleta.documento_asistente }}</p>
              <p *ngIf="boleta.email_asistente"><strong>Email:</strong> {{ boleta.email_asistente }}</p>
            </div>
            <div class="boleta-qr" *ngIf="boleta.codigo_qr && item.compra.estado_pago === 'completado'">
              <div class="qr-code">
                <span class="material-icons">qr_code</span>
                <span>{{ boleta.codigo_qr }}</span>
              </div>
            </div>
            <div class="boleta-actions" *ngIf="item.compra.estado_pago === 'completado'">
              <button class="btn-view" (click)="verBoleta(boleta, item.compra)" title="Ver boleta">
                <span class="material-icons">visibility</span>
                Ver Boleta
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading && comprasConBoletas.length === 0" class="empty-state">
    <span class="material-icons">shopping_bag</span>
    <p>No has realizado ninguna compra aún</p>
    <p class="empty-subtitle">Explora los eventos disponibles y compra tus boletas</p>
    <a routerLink="/eventos-cliente" class="btn-primary">
      <span class="material-icons">event</span>
      Ver Eventos
    </a>
  </div>

  <!-- Paginación -->
  <div *ngIf="!loading && total > limit" class="pagination">
    <div class="pagination-info">
      <span>Mostrando {{ (page - 1) * limit + 1 }} - {{ Math.min(page * limit, total) }} de {{ total }}
        resultados</span>
    </div>
    <div class="pagination-controls">
      <button class="pagination-btn" (click)="goToPage(1)" [disabled]="page === 1" title="Primera página">
        <span class="material-icons">first_page</span>
      </button>
      <button class="pagination-btn" (click)="goToPage(page - 1)" [disabled]="page === 1" title="Página anterior">
        <span class="material-icons">chevron_left</span>
      </button>

      <div class="pagination-numbers">
        <button *ngFor="let pageNum of getPageNumbers()" class="pagination-number" [class.active]="pageNum === page"
          (click)="goToPage(pageNum)">
          {{ pageNum }}
        </button>
      </div>

      <button class="pagination-btn" (click)="goToPage(page + 1)" [disabled]="page >= totalPages"
        title="Página siguiente">
        <span class="material-icons">chevron_right</span>
      </button>
      <button class="pagination-btn" (click)="goToPage(totalPages)" [disabled]="page >= totalPages"
        title="Última página">
        <span class="material-icons">last_page</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal de vista previa de boleta -->
<div class="modal-overlay" *ngIf="showBoletaModal">
  <div class="modal-content boleta-modal" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="cerrarBoletaModal()">
      <span class="material-icons">close</span>
    </button>

    <div class="boleta-preview" *ngIf="boletaSeleccionada && eventoSeleccionado && tipoBoletaSeleccionado">
      <!-- Encabezado -->
      <div class="boleta-header-preview">
        <h2>{{ eventoSeleccionado.titulo }}</h2>
        <p class="boleta-tipo">{{ tipoBoletaSeleccionado.nombre }}</p>
      </div>

      <!-- QR Code (solo si el pago está completado) -->
      <div class="boleta-qr-preview" *ngIf="compraSeleccionada?.estado_pago === 'completado'">
        <div *ngIf="loadingQR" class="qr-loading">
          <div class="spinner"></div>
          <p>Generando código QR...</p>
        </div>
        <img *ngIf="qrCodeUrl && !loadingQR" [src]="qrCodeUrl" alt="Código QR" class="qr-image">
        <p class="qr-code-text" *ngIf="!loadingQR">{{ boletaSeleccionada.codigo_qr }}</p>
      </div>
      <div class="boleta-qr-preview" *ngIf="compraSeleccionada?.estado_pago !== 'completado'">
        <div class="qr-pending">
          <span class="material-icons">lock</span>
          <p>El código QR estará disponible una vez que el pago sea completado</p>
        </div>
      </div>

      <!-- Información -->
      <div class="boleta-info-preview">
        <div class="info-row">
          <span class="info-label">Precio:</span>
          <span class="info-value">{{ formatCurrency(boletaSeleccionada.precio_unitario) }}</span>
        </div>

        <div class="info-row" *ngIf="eventoSeleccionado.fecha_inicio">
          <span class="info-label">Fecha:</span>
          <span class="info-value">{{ eventoSeleccionado.fecha_inicio | dateFormat:'full' }}</span>
        </div>

        <div class="info-row" *ngIf="eventoSeleccionado.lugar">
          <span class="info-label">Lugar:</span>
          <span class="info-value">{{ eventoSeleccionado.lugar.nombre }}</span>
        </div>

        <div class="info-row" *ngIf="eventoSeleccionado.lugar">
          <span class="info-label">Dirección:</span>
          <span class="info-value">{{ eventoSeleccionado.lugar.direccion }}, {{ eventoSeleccionado.lugar.ciudad }}</span>
        </div>

        <div class="info-row" *ngIf="boletaSeleccionada.nombre_asistente">
          <span class="info-label">Asistente:</span>
          <span class="info-value">{{ boletaSeleccionada.nombre_asistente }}</span>
        </div>

        <div class="info-row" *ngIf="boletaSeleccionada.documento_asistente">
          <span class="info-label">Documento:</span>
          <span class="info-value">{{ boletaSeleccionada.documento_asistente }}</span>
        </div>

        <div class="info-row" *ngIf="compraSeleccionada">
          <span class="info-label">Transacción:</span>
          <span class="info-value">{{ compraSeleccionada.numero_transaccion }}</span>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="boleta-actions-preview">
        <button class="btn-primary" (click)="imprimirBoletaPDF(boletaSeleccionada, compraSeleccionada!)">
          <span class="material-icons">print</span>
          Imprimir PDF
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Template oculto para impresión/PDF -->
<div id="ticket-template" class="ticket-print-container" *ngIf="boletaSeleccionada && eventoSeleccionado && tipoBoletaSeleccionado">
  <div class="ticket-card">
    <div class="ticket-left">
      <div class="ticket-header">
        <img src="/logo-eventum-horizontal.svg" alt="Eventum" class="ticket-logo" />
        <div class="ticket-event-type">TICKET DIGITAL</div>
      </div>
      
      <div class="ticket-body">
        <h1 class="ticket-title">{{ eventoSeleccionado.titulo }}</h1>
        
        <div class="ticket-info-grid">
          <div class="info-item">
            <span class="label">FECHA Y HORA</span>
            <span class="value">{{ eventoSeleccionado.fecha_inicio | dateFormat:'full' }}</span>
          </div>
          <div class="info-item">
            <span class="label">UBICACIÓN</span>
            <span class="value">{{ eventoSeleccionado.lugar?.nombre || 'Por confirmar' }}</span>
            <span class="sub-value" *ngIf="eventoSeleccionado.lugar?.direccion">{{ eventoSeleccionado.lugar?.direccion }}, {{ eventoSeleccionado.lugar?.ciudad }}</span>
          </div>
          <div class="info-item">
            <span class="label">TIPO DE BOLETA</span>
            <span class="value">{{ tipoBoletaSeleccionado.nombre }}</span>
          </div>
          <div class="info-item">
            <span class="label">PRECIO</span>
            <span class="value">{{ formatCurrency(boletaSeleccionada.precio_unitario) }}</span>
          </div>
        </div>
        
        <div class="ticket-asistente">
          <div class="info-item">
            <span class="label">ASISTENTE</span>
            <span class="value">{{ boletaSeleccionada.nombre_asistente || 'N/A' }}</span>
          </div>
          <div class="info-item" *ngIf="boletaSeleccionada.documento_asistente">
            <span class="label">DOCUMENTO</span>
            <span class="value">{{ boletaSeleccionada.documento_asistente }}</span>
          </div>
        </div>
      </div>
      
      <div class="ticket-footer">
        <div class="ticket-id">TRANSACCIÓN: {{ compraSeleccionada?.numero_transaccion }}</div>
        <div class="ticket-disclaimer">Este ticket es personal e intransferible. Presenta el código QR al ingresar.</div>
      </div>
    </div>
    
    <div class="ticket-right">
      <div class="ticket-qr-container">
        <img [src]="qrCodeUrl" alt="QR" class="ticket-qr" />
        <div class="ticket-qr-code">{{ boletaSeleccionada.codigo_qr }}</div>
      </div>
      <div class="ticket-stub-info">
        <span>EVENTUM</span>
        <span>EXPERIENCIAS INOLVIDABLES</span>
      </div>
    </div>
  </div>
</div>